@page "/notifications"
@attribute [Authorize]
@implements IDisposable
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<PageTitle>SAVORA - Notifications</PageTitle>

<PageHeader Title="Notifications" Subtitle="Restez informé de l'avancement de vos réclamations" Icon="bell">
    @if (_notifications.Any(n => !n.IsRead))
    {
        <button type="button" class="btn btn-outline-primary" @onclick="MarkAllAsRead">
            <i data-feather="check-circle" class="me-2"></i> Tout marquer comme lu
        </button>
    }
</PageHeader>

@if (_isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
        </div>
    </div>
}
else if (!_notifications.Any())
{
    <div class="card">
        <div class="card-body empty-state">
            <i data-feather="bell-off" style="width: 64px; height: 64px; color: #CBD5E1;"></i>
            <h5 class="mt-3">Aucune notification</h5>
            <p>Vous n'avez aucune notification pour le moment.</p>
        </div>
    </div>
}
else
{
    <div class="card">
        <div class="list-group list-group-flush">
            @foreach (var notification in _notifications)
            {
                <a href="javascript:void(0)" class="list-group-item list-group-item-action @(notification.IsRead ? "" : "notification-unread")" 
                   @onclick="@(() => HandleClick(notification))">
                    <div class="d-flex w-100 align-items-center">
                        <div class="me-3">
                            <div class="rounded-circle d-flex align-items-center justify-content-center @GetIconBgClass(notification.NotificationType)" 
                                 style="width: 40px; height: 40px;">
                                <i data-feather="@GetIconName(notification.NotificationType)" class="text-white" style="width: 20px; height: 20px;"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="mb-1 @(notification.IsRead ? "" : "fw-bold")">@notification.Title</h6>
                                <div class="d-flex align-items-center gap-2">
                                    <small class="text-muted">@FormatDate(notification.CreatedAt)</small>
                                    @if (!notification.IsRead)
                                    {
                                        <span class="badge rounded-pill bg-primary" style="width: 8px; height: 8px; padding: 0; min-width: 8px;"></span>
                                    }
                                </div>
                            </div>
                            <p class="mb-0 text-muted">@notification.Message</p>
                        </div>
                    </div>
                </a>
            }
        </div>
    </div>
}

@code {
    private List<NotificationDto> _notifications = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadNotifications();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JSRuntime.InvokeVoidAsync("initFeatherIcons");
        
        if (firstRender)
        {
            // Refresh notifications when navigating to this page
            Navigation.LocationChanged += OnLocationChanged;
        }
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        if (e.Location.Contains("/notifications"))
        {
            await LoadNotifications();
            StateHasChanged();
        }
    }

    private async Task LoadNotifications()
    {
        _isLoading = true;
        try
        {
            var result = await NotificationService.GetAllAsync();
            if (result.Success && result.Data != null)
            {
                _notifications = result.Data.OrderByDescending(n => n.CreatedAt).ToList();
                if (_notifications.Count == 0)
                {
                    // No notifications - this is normal, don't show error
                }
            }
            else
            {
                Snackbar.Add($"Erreur lors du chargement: {result.Message ?? "Erreur inconnue"}", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erreur: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleClick(NotificationDto notification)
    {
        // Mark as read first
        if (!notification.IsRead)
        {
            var result = await NotificationService.MarkAsReadAsync(notification.Id);
            if (result.Success)
            {
                notification.IsRead = true;
                StateHasChanged();
            }
            else
            {
                Snackbar.Add($"Erreur: {result.Message}", Severity.Error);
                return; // Don't navigate if marking as read failed
            }
        }

        // Navigate to related entity
        if (notification.RelatedEntityId.HasValue)
        {
            if (notification.RelatedEntityType == "Reclamation")
            {
                Navigation.NavigateTo($"/reclamations/{notification.RelatedEntityId}");
            }
            else if (notification.RelatedEntityType == "Intervention")
            {
                Navigation.NavigateTo($"/interventions/{notification.RelatedEntityId}");
            }
        }
    }

    private async Task MarkAllAsRead()
    {
        var result = await NotificationService.MarkAllAsReadAsync();
        if (result.Success)
        {
            foreach (var n in _notifications)
            {
                n.IsRead = true;
            }
            StateHasChanged();
            Snackbar.Add("Toutes les notifications marquées comme lues", Severity.Success);
        }
        else
        {
            Snackbar.Add($"Erreur: {result.Message}", Severity.Error);
        }
    }

    private string GetIconName(string type) => type switch
    {
        "StatusChange" => "refresh-cw",
        "ReclamationCreated" => "alert-circle",
        "NewIntervention" => "tool",
        "InterventionAssigned" => "user-check",
        "InterventionStarted" => "play-circle",
        "InterventionCompleted" => "check-circle",
        "InterventionCancelled" => "x-circle",
        "InvoiceReady" => "file-text",
        "ReclamationClosed" => "check-circle",
        _ => "bell"
    };

    private string GetIconBgClass(string type) => type switch
    {
        "StatusChange" => "bg-primary",
        "ReclamationCreated" => "bg-info",
        "NewIntervention" => "bg-warning",
        "InterventionAssigned" => "bg-primary",
        "InterventionStarted" => "bg-success",
        "InterventionCompleted" => "bg-success",
        "InterventionCancelled" => "bg-danger",
        "InvoiceReady" => "bg-info",
        "ReclamationClosed" => "bg-success",
        _ => "bg-secondary"
    };

    private string FormatDate(DateTime date)
    {
        var diff = DateTime.UtcNow - date;
        
        if (diff.TotalMinutes < 60)
            return $"Il y a {(int)diff.TotalMinutes} min";
        if (diff.TotalHours < 24)
            return $"Il y a {(int)diff.TotalHours} h";
        if (diff.TotalDays < 7)
            return $"Il y a {(int)diff.TotalDays} j";
        
        return date.ToString("dd/MM/yyyy");
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}

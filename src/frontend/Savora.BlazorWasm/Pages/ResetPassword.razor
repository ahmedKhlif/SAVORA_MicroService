@page "/reset-password"
@layout EmptyLayout
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<PageTitle>SAVORA - R√©initialiser le mot de passe</PageTitle>

<div class="main d-flex justify-content-center w-100 auth-page">
    <main class="content d-flex p-0">
        <div class="container d-flex flex-column">
            <div class="row vh-100">
                <div class="col-sm-10 col-md-8 col-lg-6 col-xl-5 mx-auto d-table h-100">
                    <div class="d-table-cell align-middle">
                        
                        <div class="text-center mt-4 mb-4">
                            <img src="img/logo.png" alt="SAVORA" height="60" class="mb-3" />
                            <h1 class="h2">Nouveau mot de passe</h1>
                            <p class="lead text-muted">
                                Cr√©ez votre nouveau mot de passe
                            </p>
                        </div>

                        <div class="card shadow-lg">
                            <div class="card-body">
                                @if (_resetSuccess)
                                {
                                    <div class="text-center py-4">
                                        <div class="mb-4">
                                            <i class="align-middle text-success" data-feather="check-circle" style="width: 64px; height: 64px;"></i>
                                        </div>
                                        <h4 class="text-success">Mot de passe r√©initialis√©!</h4>
                                        <p class="text-muted mb-4">
                                            Votre mot de passe a √©t√© modifi√© avec succ√®s.
                                            Vous pouvez maintenant vous connecter.
                                        </p>
                                        <a href="/login" class="btn btn-primary btn-lg">
                                            <i class="align-middle me-1" data-feather="log-in"></i>
                                            Se connecter
                                        </a>
                                    </div>
                                }
                                else if (string.IsNullOrEmpty(_token))
                                {
                                    <div class="text-center py-4">
                                        <div class="mb-4">
                                            <i class="align-middle text-danger" data-feather="alert-circle" style="width: 64px; height: 64px;"></i>
                                        </div>
                                        <h4 class="text-danger">Lien invalide</h4>
                                        <p class="text-muted mb-4">
                                            Ce lien de r√©initialisation est invalide ou a expir√©.
                                        </p>
                                        <a href="/forgot-password" class="btn btn-primary">
                                            Demander un nouveau lien
                                        </a>
                                    </div>
                                }
                                else
                                {
                                    <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
                                        <DataAnnotationsValidator />
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Nouveau mot de passe</label>
                                            <InputText type="password" @bind-Value="_model.NewPassword" class="form-control form-control-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                                            <ValidationMessage For="@(() => _model.NewPassword)" class="text-danger" />
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Confirmer le mot de passe</label>
                                            <InputText type="password" @bind-Value="_model.ConfirmPassword" class="form-control form-control-lg" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                                            <ValidationMessage For="@(() => _model.ConfirmPassword)" class="text-danger" />
                                        </div>

                                        @if (!string.IsNullOrEmpty(_errorMessage))
                                        {
                                            <div class="alert alert-danger" role="alert">
                                                @_errorMessage
                                            </div>
                                        }

                                        <div class="d-grid gap-2 mt-4">
                                            <button type="submit" class="btn btn-lg btn-primary" disabled="@_isLoading">
                                                @if (_isLoading)
                                                {
                                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                                    <span>R√©initialisation...</span>
                                                }
                                                else
                                                {
                                                    <span>üîê R√©initialiser le mot de passe</span>
                                                }
                                            </button>
                                        </div>
                                    </EditForm>
                                }
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    private string? _token;
    private ResetPasswordModel _model = new();
    private bool _isLoading = false;
    private bool _resetSuccess = false;
    private string? _errorMessage;

    protected override void OnInitialized()
    {
        _token = Token;
    }

    private async Task HandleSubmit()
    {
        _errorMessage = null;

        if (_model.NewPassword != _model.ConfirmPassword)
        {
            _errorMessage = "Les mots de passe ne correspondent pas";
            return;
        }

        _isLoading = true;
        try
        {
            var result = await AuthService.ResetPasswordAsync(_token!, _model.NewPassword);
            
            if (result.Success)
            {
                _resetSuccess = true;
                Snackbar.Add("Mot de passe r√©initialis√© avec succ√®s!", Severity.Success);
            }
            else
            {
                _errorMessage = result.Message ?? "Erreur lors de la r√©initialisation";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Erreur: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    public class ResetPasswordModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Le mot de passe est requis")]
        [System.ComponentModel.DataAnnotations.MinLength(6, ErrorMessage = "Minimum 6 caract√®res")]
        public string NewPassword { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "La confirmation est requise")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JSRuntime.InvokeVoidAsync("initFeatherIcons");
    }
}

